name: Build and Release

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version
        id: version
        run: |
          build_number=$(git rev-list --count HEAD)
          version="1.0.${build_number}"
          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "build_number=${build_number}" >> $GITHUB_OUTPUT

  build-windows:
    runs-on: windows-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build JAR with Maven
        run: mvn -B clean package

      - name: Create Windows Installer (.exe)
        run: |
          mkdir dist
          copy src\res\logo.png dist\logo.png
          copy target\translator-1.0.jar dist\translator.jar
          jpackage ^
            --type exe ^
            --input dist ^
            --main-jar translator.jar ^
            --name "Global Translator Plus" ^
            --app-version "${{ needs.prepare.outputs.version }}" ^
            --vendor "JS Enterprise" ^
            --icon dist\logo.png ^
            --win-menu ^
            --win-shortcut ^
            --win-dir-chooser ^
            --win-menu-group "JS Enterprise" ^
            --win-per-user-install ^
            --verbose
        shell: cmd

      - name: Upload Windows .exe
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: "*.exe"

  build-linux:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Install packaging dependencies
        run: sudo apt-get update && sudo apt-get install -y fakeroot rpm

      - name: Build JAR with Maven
        run: mvn -B clean package

      - name: Create Linux Installer (.deb)
        run: |
          mkdir dist
          cp src/res/logo.png dist/logo.png
          cp target/translator-1.0.jar dist/translator.jar
          jpackage \
            --type deb \
            --input dist \
            --main-jar translator.jar \
            --name "Global Translator Plus" \
            --app-version "${{ needs.prepare.outputs.version }}" \
            --vendor "JS Enterprise" \
            --icon dist/logo.png \
            --linux-shortcut \
            --linux-menu-group "JS Enterprise" \
            --verbose
        shell: bash

      - name: Upload Linux .deb
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: "*.deb"

  create-release:
    runs-on: ubuntu-latest
    needs: [prepare, build-windows, build-linux]
    steps:
      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: release

      - name: Download Linux installer
        uses: actions/download-artifact@v4
        with:
          name: linux-installer
          path: release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Global Translator Plus v${{ needs.prepare.outputs.version }}"
          tag_name: "v${{ needs.prepare.outputs.version }}"
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
