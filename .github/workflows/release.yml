name: Build and Release

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version
        id: version
        run: |
          build_number=$(git rev-list --count HEAD)
          version="1.0.${build_number}"
          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "build_number=${build_number}" >> $GITHUB_OUTPUT

  build-windows:
    runs-on: windows-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build Windows executable
        run: |
          mkdir dist
          xcopy src\res\logo.png dist\logo.png /Y
          copy translator-1.0.jar dist\translator.jar /Y
          echo "Creating Windows executable..."
          jpackage ^
            --type exe ^
            --input dist ^
            --main-jar translator.jar ^
            --name "Global Translator Plus" ^
            --app-version "${{ needs.prepare.outputs.version }}" ^
            --vendor "JS Enterprise" ^
            --icon dist\logo.png ^
            --win-menu ^
            --win-shortcut ^
            --win-dir-chooser ^
            --win-menu-group "JS Enterprise"
        shell: cmd

      - name: Archive Windows build
        run: |
          mkdir release
          powershell Compress-Archive -Path "dist\*" -DestinationPath "release\GlobalTranslatorPlus_Windows.zip"
        shell: powershell

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: release/GlobalTranslatorPlus_Windows.zip

  build-linux:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Download and extract JRE 21 for Linux
        run: |
          echo "Downloading JRE 21 for Linux..."
          wget -q "https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz" -O jdk-linux.tar.gz
          echo "Extracting JRE..."
          tar -xzf jdk-linux.tar.gz
          extracted_dir=$(tar -tzf jdk-linux.tar.gz | head -1 | cut -f1 -d"/")
          mv "$extracted_dir" jdk-21

      - name: Build Linux package
        run: |
          mkdir dist
          cp src/res/logo.png dist/logo.png
          cp translator-1.0.jar dist/translator.jar
          echo "Creating Linux executable..."
          jpackage \
            --type app-image \
            --input dist \
            --main-jar translator.jar \
            --name "Global Translator Plus" \
            --app-version "${{ needs.prepare.outputs.version }}" \
            --vendor "JS Enterprise" \
            --icon dist/logo.png
          tar -czf GlobalTranslatorPlus_Linux.tar.gz Global\ Translator\ Plus/

      - name: Upload artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: GlobalTranslatorPlus_Linux.tar.gz

  create-release:
    runs-on: ubuntu-latest
    needs: [prepare, build-windows, build-linux]
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: release

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Global Translator Plus v${{ needs.prepare.outputs.version }}"
          tag_name: "v${{ needs.prepare.outputs.version }}"
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
