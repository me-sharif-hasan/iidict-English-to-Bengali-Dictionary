name: Build and Release

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version
        id: version
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          BASE_VERSION=$(grep -oPm1 "(?<=<version>)[^<]+" pom.xml | head -1)
          VERSION="${BASE_VERSION}.${BUILD_NUMBER}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Update version in pom.xml
        shell: pwsh
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          (Get-Content pom.xml) -replace '<version>1\.0</version>', "<version>$version</version>" | Set-Content pom.xml

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Download JDK 21 for Windows
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://download.oracle.com/java/21/latest/jdk-21_windows-x64_bin.zip" -OutFile "jdk-windows.zip"
          Expand-Archive -Path "jdk-windows.zip" -DestinationPath "."
          $jdkDir = Get-ChildItem -Directory | Where-Object { $_.Name -like "jdk-*" } | Select-Object -First 1
          Rename-Item $jdkDir.Name "jdk-21"

      - name: Create runtime image
        shell: pwsh
        run: |
          if (Test-Path runtime) { Remove-Item runtime -Recurse -Force }
          .\jdk-21\bin\jlink.exe --module-path .\jdk-21\jmods --add-modules java.base,java.desktop --output runtime --compress=2 --no-header-files --no-man-pages

      - name: Install WiX Toolset
        shell: pwsh
        run: choco install wixtoolset -y

      - name: Package Windows EXE
        shell: pwsh
        run: |
          mkdir package-input
          Copy-Item "target/translator-${{ needs.prepare.outputs.version }}.jar" "package-input/translator.jar"

          .\jdk-21\bin\jpackage.exe `
            --type exe `
            --input package-input `
            --main-jar translator.jar `
            --main-class com.iishanto.Main `
            --name "Global Translator Plus" `
            --runtime-image runtime `
            --app-version "${{ needs.prepare.outputs.version }}" `
            --vendor "JS Enterprise" `
            --icon "src\res\logo.png" `
            --win-menu `
            --win-shortcut `
            --dest installer-output

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer-output/*.exe

  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Update version in pom.xml
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          sed -i "s/<version>1\.0<\/version>/<version>${VERSION}<\/version>/" pom.xml

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Download JDK 21 for Linux
        run: |
          wget -q "https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz" -O jdk-linux.tar.gz
          tar -xzf jdk-linux.tar.gz
          JDK_DIR=$(ls -d jdk-* | head -n 1)
          mv "$JDK_DIR" jdk-21

      - name: Create runtime image
        run: |
          rm -rf runtime || true
          ./jdk-21/bin/jlink --module-path ./jdk-21/jmods --add-modules java.base,java.desktop --output runtime --compress=2 --no-header-files --no-man-pages

      - name: Install required packages
        run: sudo apt-get update && sudo apt-get install -y fakeroot binutils

      - name: Package Linux DEB
        run: |
          mkdir -p package-input
          cp target/translator-${{ needs.prepare.outputs.version }}.jar package-input/translator.jar

          ./jdk-21/bin/jpackage \
            --type deb \
            --input package-input \
            --main-jar translator.jar \
            --main-class com.iishanto.Main \
            --name "Global Translator Plus" \
            --runtime-image runtime \
            --app-version "${{ needs.prepare.outputs.version }}" \
            --vendor "JS Enterprise" \
            --icon src/res/logo.png \
            --linux-menu-group "Education" \
            --linux-shortcut \
            --dest installer-output

      - name: Upload Linux Installer
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: installer-output/*.deb

  create-release:
    needs: [prepare, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./artifacts/windows

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-installer
          path: ./artifacts/linux

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Release v${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/windows/*.exe
            artifacts/linux/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
